SELECT
  measurementUUID AS uuid,
  DATETIME(TIMESTAMP(measurementTime), "UTC") AS test_time,
  clientCity AS city,
  clientRegion AS region,
  clientCountry AS country_iso,
  clientASN AS asn,
  ROUND(packetLoss.lossRatio, 5) AS packet_loss_rate,

  ROUND((SELECT PERCENTILE_DISC(bps, 0.5) OVER () FROM UNNEST(download.bps) AS bps LIMIT 1) / 1000000, 5) AS download_throughput_mbps,
  CAST(ROUND((SELECT PERCENTILE_DISC(ltc, 0.5) OVER () FROM UNNEST(loadedLatencyMs.download) AS ltc LIMIT 1), 0) AS INT) AS download_latency_ms,
  ROUND(loadedJitterMs.download, 5) AS download_jitter,
  (SELECT bytes
    FROM (
      SELECT bytes, bps FROM UNNEST(download.bps) AS bps WITH OFFSET AS i JOIN UNNEST(download.bytes) AS bytes WITH OFFSET AS j ON i = j
    ) sq
    WHERE sq.bps = (SELECT PERCENTILE_DISC(bps, 0.5) OVER () FROM UNNEST(download.bps) AS bps LIMIT 1) LIMIT 1
  ) AS download_bytes_bps,

  ROUND((SELECT PERCENTILE_DISC(bps, 0.5) OVER () FROM UNNEST(upload.bps) AS bps LIMIT 1) / 1000000, 5) AS upload_throughput_mbps,
  CAST(ROUND((SELECT PERCENTILE_DISC(ltc, 0.5) OVER () FROM UNNEST(loadedLatencyMs.upload) AS ltc LIMIT 1), 0) AS INT) AS upload_latency_ms,
  ROUND(loadedJitterMs.upload, 5) AS upload_jitter,
  (SELECT bytes 
    FROM (
      SELECT bytes, bps FROM UNNEST(upload.bps) AS bps WITH OFFSET AS i JOIN UNNEST(upload.bytes) AS bytes WITH OFFSET AS j ON i = j
    ) sq 
    WHERE sq.bps = (SELECT PERCENTILE_DISC(bps, 0.5) OVER () FROM UNNEST(upload.bps) AS bps LIMIT 1) LIMIT 1
  ) AS upload_bytes
FROM `measurement-lab.cloudflare.speedtest_speed1`
WHERE date >= '2025-05-05'
  AND date <= '2025-05-07'
  AND clientCountry IS NOT NULL
  AND clientASN IN (42313, 50973, 35047, 198279, 206262, 23657, 9751, 22927, 7303, 7049, 52361, 11664, 12297, 8932, 49800, 43733, 33852, 4826, 1221, 137409, 7474, 7545, 1764, 8447, 47147, 1853, 25255, 29049, 196925, 211995, 34170, 28787, 15146, 8014, 18635, 19128, 19377, 58717, 132602, 10075, 17494, 132884, 35900, 14813, 10278, 55033, 46764, 6774, 6696, 31713, 34872, 5432, 28683, 37090, 328228, 37292, 328092, 17660, 38740, 18024, 136039, 7615, 37678, 14988, 37395, 329381, 36963, 16735, 10429, 22356, 53013, 262589, 44901, 8717, 57344, 8866, 34224, 37545, 327799, 37336, 327798, 25429, 15964, 30992, 36912, 37672, 36955, 577, 6327, 852, 812, 21949, 37517, 37575, 327862, 328941, 328440, 329173, 329138, 328594, 328310, 327802, 327975, 327756, 263237, 14259, 263702, 7004, 27986, 7195, 52320, 262191, 14080, 27951, 10131, 152093, 262197, 11830, 52263, 52228, 3790, 5391, 44306, 15994, 13046, 205714, 6866, 35432, 8544, 15805, 5504, 39392, 16019, 29208, 5610, 47232, 31027, 2603, 3292, 3342, 39642, 64126, 265721, 272112, 264821, 272110, 153183, 58731, 140223, 133606, 136920, 19114, 23487, 27947, 263238, 61468, 263783, 262199, 16592, 264635, 265780, 3249, 2586, 8240, 8728, 3204, 38442, 45349, 4638, 9241, 24390, 6667, 47605, 719, 1759, 16086, 5511, 35280, 8218, 30781, 29075, 263175, 27806, 265745, 264728, 272128, 262190, 27675, 25250, 327719, 37309, 37323, 37503, 35805, 20771, 44327, 16010, 49628, 3320, 33891, 5405, 13237, 8881, 37613, 327992, 29614, 37350, 30997, 12713, 3329, 25472, 1241, 6799, 21351, 63351, 17149, 29837, 401198, 7444, 395470, 212775, 397385, 3605, 9246, 17456, 395400, 23676, 262206, 14754, 23243, 26617, 52286, 212565, 34738, 34497, 48210, 205514, 52253, 19863, 52433, 264694, 270108, 27759, 27653, 52260, 263685, 27774, 22869, 27884, 27696, 265680, 27932, 39533, 5483, 29278, 12301, 47169, 44735, 6677, 12969, 30818, 56704, 7713, 38158, 136106, 55655, 23947, 31122, 39122, 2110, 5466, 207044, 6762, 12874, 3269, 41327, 28716, 33576, 30689, 40786, 10292, 3586, 7660, 2497, 2516, 17676, 2500, 8697, 9038, 48832, 8376, 211826, 35168, 41798, 9198, 35104, 21299, 328578, 36926, 33771, 37061, 15808, 134783, 132486, 4865, 140066, 12578, 2588, 5518, 8194, 24589, 37094, 328136, 37580, 37410, 37203, 28917, 13194, 8764, 56630, 8849, 199524, 6661, 29467, 56665, 60725, 34772, 6821, 34547, 200899, 43612, 37054, 37037, 328411, 37303, 37608, 36944, 37440, 37294, 37187, 36913, 4788, 9930, 45352, 38182, 9534, 7642, 24016, 150125, 55944, 136238, 12709, 15735, 33874, 5532, 20521, 20776, 48252, 47798, 51110, 60046, 37614, 18734, 11172, 8151, 19332, 28458, 10130, 139759, 38875, 45193, 58524, 25454, 8926, 9199, 43289, 15836, 45204, 55805, 17882, 139089, 9484, 37697, 30619, 25139, 37223, 328460, 136168, 45558, 136255, 133524, 132167, 55722, 140504, 141368, 152706, 55723, 20495, 6830, 15830, 20562, 20965, 9790, 4648, 135069, 55850, 45177, 37385, 37531, 329224, 37233, 26130, 37282, 37148, 29465, 36873, 36940, 45168, 38234, 7131, 9839, 2119, 2116, 25400, 50304, 29695, 28885, 50010, 204170, 201684, 212661, 12975, 51407, 42013, 12754, 51336, 52468, 11556, 18809, 26105, 262248, 61512, 28008, 23201, 52229, 269783, 262253, 27843, 21575, 6147, 263681, 9299, 4775, 135607, 17639, 9658, 5617, 12741, 50263, 201054, 20804, 6424, 8657, 2860, 47787, 15525, 21559, 10396, 11992, 23379, 6208, 8781, 48728, 42298, 29384, 211559, 49902, 37002, 327697, 327956, 34306, 9009, 6204, 6663, 8708, 9050, 327708, 36890, 37619, 37228, 327707, 399642, 399280, 11822, 30077, 393894, 395916, 988, 1007, 40573, 985, 46408, 398901, 32055, 36110, 38800, 17993, 38227, 133747, 153053, 31042, 21215, 13004, 8400, 15958, 329109, 328297, 328581, 37208, 37164, 7473, 64049, 24482, 4657, 23855, 27781, 262181, 27734, 27974, 59796, 5578, 6855, 31117, 29405, 62255, 5603, 34779, 9119, 3212, 139609, 45891, 132468, 132462, 24013, 3741, 37271, 16637, 5713, 37497, 328605, 327786, 37406, 36892, 37594, 12956, 29119, 60171, 12430, 12357, 45489, 18001, 9329, 45356, 38229, 15706, 33788, 37211, 36972, 36998, 19711, 32398, 327765, 328169, 37510, 1299, 12552, 1257, 3301, 42708, 3303, 6730, 13030, 34927, 25091, 132579, 38198, 38201, 132831, 140987, 27665, 5639, 27789, 264811, 27800, 23917, 142573, 133117, 14434, 393275, 22581, 20243, 400992, 3326, 35297, 35320, 3255, 197563, 8529, 8966, 59692, 59605, 15802, 9002, 8220, 15412, 3223, 41095, 3356, 174, 3257, 2914, 6939, 14593, 6057, 27750, 19422, 20255, 20002, 45495, 133383, 9249, 43357, 45935, 21826, 61461, 263703, 8048, 27717, 30873, 12486, 204317, 51140, 212951, 201051, 37154, 36962, 7420, 37287, 37532, 37204, 37183, 329006, 37184, 37332)